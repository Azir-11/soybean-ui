<script setup lang="ts">
import type { PrimitiveProps } from '../primitive/types';

import Primitive from '../primitive/primitive';
import { injectSliderRootContext } from './slider-root.vue';
import { ARROW_KEYS, PAGE_KEYS } from './utils';

export type SliderImplEmits = {
  slideStart: [event: PointerEvent];
  slideMove: [event: PointerEvent];
  slideEnd: [event: PointerEvent];
  homeKeyDown: [event: KeyboardEvent];
  endKeyDown: [event: KeyboardEvent];
  stepKeyDown: [event: KeyboardEvent];
};

export interface SliderImplProps extends PrimitiveProps {}

const props = withDefaults(defineProps<SliderImplProps>(), {
  as: 'span'
});
const emit = defineEmits<SliderImplEmits>();
const rootContext = injectSliderRootContext();
</script>

<template>
  <Primitive
    data-slider-impl
    v-bind="props"
    @keydown="
      event => {
        if (event.key === 'Home') {
          emit('homeKeyDown', event);
          // Prevent scrolling to page start
          event.preventDefault();
        } else if (event.key === 'End') {
          emit('endKeyDown', event);
          // Prevent scrolling to page end
          event.preventDefault();
        } else if (PAGE_KEYS.concat(ARROW_KEYS).includes(event.key)) {
          emit('stepKeyDown', event);
          // Prevent scrolling for directional key presses
          event.preventDefault();
        }
      }
    "
    @pointerdown="
      event => {
        const target = event.target as HTMLElement;
        target.setPointerCapture(event.pointerId);
        // Prevent browser focus behaviour because we focus a thumb manually when values change.
        event.preventDefault();
        // Touch devices have a delay before focusing so won't focus if touch immediately moves
        // away from target (sliding). We want thumb to focus regardless.
        if (rootContext.thumbElements.value.includes(target)) {
          target.focus();
        } else {
          emit('slideStart', event);
        }
      }
    "
    @pointermove="
      event => {
        const target = event.target as HTMLElement;
        if (target.hasPointerCapture(event.pointerId)) emit('slideMove', event);
      }
    "
    @pointerup="
      event => {
        const target = event.target as HTMLElement;
        if (target.hasPointerCapture(event.pointerId)) {
          target.releasePointerCapture(event.pointerId);
          emit('slideEnd', event);
        }
      }
    "
  >
    <slot />
  </Primitive>
</template>
